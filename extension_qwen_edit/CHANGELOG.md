# Qwen图片编辑插件 - 更新日志

## 版本 2.0.0 (2024-12-24)

### 主要改进

#### 1. API调用优化
- **右键菜单快速编辑**: 现在只使用基础参数(`prompt`, `size`, `image_url`)
- **自定义编辑**: 支持完整参数,包括负向提示词、采样步数、引导系数、随机种子等
- **默认模型**: 使用 `Qwen/Qwen-Image-Edit-2511`

#### 2. 读秒倒计时功能
- 点击"开始编辑"或"生成图片"按钮后,进度区域会显示实时等待时间
- 格式: "正在提交任务... (已等待: X秒)" 或 " (已等待: X分Y秒)"
- 生成完成或出错时自动停止计时

#### 3. 图片上传和缩略图功能
- **双模式输入**:
  - URL输入: 输入图片URL并点击"添加"按钮
  - 本地上传: 点击或拖拽上传本地图片文件
- **缩略图展示**: 所有添加的图片以缩略图网格形式展示
- **删除功能**: 每个缩略图右上角有删除按钮,方便移除图片
- **类型标识**: 显示图片来源(本地/URL)

#### 4. 现代化设置界面UI
- **Token显示区域**:
  - 渐变背景显示当前Token状态
  - 自动显示Token来源(手动设置/环境变量)
  - Token部分隐藏显示(前8位...后4位)
  - 可展开/收起手动输入框
- **输入框优化**:
  - 圆角边框,更现代的视觉风格
  - Focus时高亮边框和阴影效果
  - 下拉菜单带自定义箭头图标
- **布局优化**:
  - 设置项间距增大,更清晰
  - 分隔线区分不同设置组
  - 响应式设计,最大宽度600px

#### 5. 代码质量改进
- 修复TypeScript诊断警告:
  - background.js: 未使用的`sender`参数改为`_sender`
  - sidebar.js: 未使用的`sendResponse`参数改为`_sendResponse`
  - content.js: 未使用的`sender`参数改为`_sender`
- 优化API调用逻辑,支持快速编辑和完整编辑两种模式

### 功能细节

#### 右键菜单快速编辑
1. 在网页图片上右键点击
2. 选择"使用Qwen编辑图片"
3. 侧边栏自动打开并显示原图
4. 输入编辑提示词
5. 点击"开始编辑"
6. 等待生成(会显示实时等待时间)

#### 自定义编辑模式
1. 点击插件图标打开侧边栏
2. 选择"URL输入"或"本地上传"标签页
3. 添加图片(URL或上传文件)
4. 在缩略图区域查看已添加图片
5. 设置分辨率和其他参数
6. 输入正向提示词(可选负向提示词)
7. 点击"生成图片"
8. 等待生成(会显示实时等待时间)

#### 设置Token
1. 点击侧边栏右上角设置图标(⚙️)
2. 查看当前Token状态(渐变卡片)
3. 点击"手动设置Token"按钮展开输入框
4. 输入Token并保存

### 技术改进

- **API封装**: `api.js`中的`submitEditTask`方法新增`isQuickEdit`参数
- **状态管理**: 添加`uploadedImages`数组管理上传的图片
- **计时器管理**: `countdownInterval`变量管理读秒计时器
- **事件监听**: 优化事件监听器初始化逻辑

### 已知限制

1. **环境变量Token**: Chrome扩展无法直接读取系统环境变量`MODELSCOPE_SDK_TOKEN`,需要手动在设置中输入
2. **图片格式**: 支持PNG、JPG、JPEG、GIF、BMP格式
3. **图片数量**: 建议不超过6张(符合ModelScope API限制)
4. **生成时间**: 通常需要30秒到几分钟,请耐心等待

### 文件变更清单

**修改的文件:**
- `manifest.json`: 更新配置,添加sidePanel权限
- `scripts/api.js`: 优化API调用,支持快速编辑模式
- `scripts/background.js`: 修复TypeScript警告,添加getEnvToken处理
- `scripts/sidebar.js`: 添加图片上传、缩略图、读秒、Token显示等功能
- `sidebar.html`: 添加图片上传界面和Token显示组件
- `styles/sidebar.css`: 添加新功能样式,优化设置界面UI

**新增的文件:**
- `CHANGELOG.md`: 本更新日志

### 下一步计划

- [ ] 支持批量下载生成的图片
- [ ] 添加历史记录功能
- [ ] 支持LoRA模型配置
- [ ] 添加图片预览放大功能
- [ ] 优化移动端适配

## 版本 1.0.0
- 初始版本,基本的图片编辑功能
